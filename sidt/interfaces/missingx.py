
from bs4 import BeautifulSoup
import requests


class Missingx:
    def __init__(self):
        self.headers = {'content-type': 'application/x-www-form-urlencoded; charset=UTF-8'}
        self.search_token = "psECuSSfiQ"

    def search(self, year:int, month:int, day:int, operator:list, query:str = ""):
        results = []

        requests.post(
            'https://www.missingx.com/en/search/updateusersearch',
            headers=self.headers,
            data=f'SearchToken={self.search_token}&SearchWords={query}&LostDate={day}%2F{month}%2F{year}&OperationType=Train&CountryId=221&CountryName=United+Kingdom&LocationName={operator[0]}&OperatorId={operator[1]}&SearchStepPage=6&PageNumber=1&LanguageId=&AssociateId=0&OperationLogoPath=client-icons%2Favanti.png&OperatedBy=&TotalItemsCount=0&ColorId=0&AirlineId=&FlightNo=&TrainStationName=&TrainStationUid=&IsClaimsOnly=false&AirlinesSelectionOptions=&ColorList%5B0%5D%5BDisabled%5D=false&ColorList%5B0%5D%5BGroup%5D=&ColorList%5B0%5D%5BSelected%5D=true&ColorList%5B0%5D%5BText%5D=Undefined&ColorList%5B0%5D%5BValue%5D=0&ColorList%5B1%5D%5BDisabled%5D=false&ColorList%5B1%5D%5BGroup%5D=&ColorList%5B1%5D%5BSelected%5D=false&ColorList%5B1%5D%5BText%5D=Black&ColorList%5B1%5D%5BValue%5D=1&ColorList%5B2%5D%5BDisabled%5D=false&ColorList%5B2%5D%5BGroup%5D=&ColorList%5B2%5D%5BSelected%5D=false&ColorList%5B2%5D%5BText%5D=White&ColorList%5B2%5D%5BValue%5D=2&ColorList%5B3%5D%5BDisabled%5D=false&ColorList%5B3%5D%5BGroup%5D=&ColorList%5B3%5D%5BSelected%5D=false&ColorList%5B3%5D%5BText%5D=Red&ColorList%5B3%5D%5BValue%5D=3&ColorList%5B4%5D%5BDisabled%5D=false&ColorList%5B4%5D%5BGroup%5D=&ColorList%5B4%5D%5BSelected%5D=false&ColorList%5B4%5D%5BText%5D=Green&ColorList%5B4%5D%5BValue%5D=4&ColorList%5B5%5D%5BDisabled%5D=false&ColorList%5B5%5D%5BGroup%5D=&ColorList%5B5%5D%5BSelected%5D=false&ColorList%5B5%5D%5BText%5D=Blue&ColorList%5B5%5D%5BValue%5D=5&ColorList%5B6%5D%5BDisabled%5D=false&ColorList%5B6%5D%5BGroup%5D=&ColorList%5B6%5D%5BSelected%5D=false&ColorList%5B6%5D%5BText%5D=Yellow&ColorList%5B6%5D%5BValue%5D=6&ColorList%5B7%5D%5BDisabled%5D=false&ColorList%5B7%5D%5BGroup%5D=&ColorList%5B7%5D%5BSelected%5D=false&ColorList%5B7%5D%5BText%5D=Brown&ColorList%5B7%5D%5BValue%5D=7&ColorList%5B8%5D%5BDisabled%5D=false&ColorList%5B8%5D%5BGroup%5D=&ColorList%5B8%5D%5BSelected%5D=false&ColorList%5B8%5D%5BText%5D=Grey&ColorList%5B8%5D%5BValue%5D=8&ColorList%5B9%5D%5BDisabled%5D=false&ColorList%5B9%5D%5BGroup%5D=&ColorList%5B9%5D%5BSelected%5D=false&ColorList%5B9%5D%5BText%5D=Silver+%2F+Silver+metal&ColorList%5B9%5D%5BValue%5D=9&ColorList%5B10%5D%5BDisabled%5D=false&ColorList%5B10%5D%5BGroup%5D=&ColorList%5B10%5D%5BSelected%5D=false&ColorList%5B10%5D%5BText%5D=Gold+%2F+Yellow+metal&ColorList%5B10%5D%5BValue%5D=10&ColorList%5B11%5D%5BDisabled%5D=false&ColorList%5B11%5D%5BGroup%5D=&ColorList%5B11%5D%5BSelected%5D=false&ColorList%5B11%5D%5BText%5D=Purple&ColorList%5B11%5D%5BValue%5D=11&ColorList%5B12%5D%5BDisabled%5D=false&ColorList%5B12%5D%5BGroup%5D=&ColorList%5B12%5D%5BSelected%5D=false&ColorList%5B12%5D%5BText%5D=Pink&ColorList%5B12%5D%5BValue%5D=12&ColorList%5B13%5D%5BDisabled%5D=false&ColorList%5B13%5D%5BGroup%5D=&ColorList%5B13%5D%5BSelected%5D=false&ColorList%5B13%5D%5BText%5D=Transparent&ColorList%5B13%5D%5BValue%5D=13&ColorList%5B14%5D%5BDisabled%5D=false&ColorList%5B14%5D%5BGroup%5D=&ColorList%5B14%5D%5BSelected%5D=false&ColorList%5B14%5D%5BText%5D=Dark+Blue&ColorList%5B14%5D%5BValue%5D=14&ColorList%5B15%5D%5BDisabled%5D=false&ColorList%5B15%5D%5BGroup%5D=&ColorList%5B15%5D%5BSelected%5D=false&ColorList%5B15%5D%5BText%5D=Dark+Green&ColorList%5B15%5D%5BValue%5D=15&ColorList%5B16%5D%5BDisabled%5D=false&ColorList%5B16%5D%5BGroup%5D=&ColorList%5B16%5D%5BSelected%5D=false&ColorList%5B16%5D%5BText%5D=Light+Blue&ColorList%5B16%5D%5BValue%5D=16&ColorList%5B17%5D%5BDisabled%5D=false&ColorList%5B17%5D%5BGroup%5D=&ColorList%5B17%5D%5BSelected%5D=false&ColorList%5B17%5D%5BText%5D=Light+Green&ColorList%5B17%5D%5BValue%5D=17&ColorList%5B18%5D%5BDisabled%5D=false&ColorList%5B18%5D%5BGroup%5D=&ColorList%5B18%5D%5BSelected%5D=false&ColorList%5B18%5D%5BText%5D=Multicolor&ColorList%5B18%5D%5BValue%5D=18&ColorList%5B19%5D%5BDisabled%5D=false&ColorList%5B19%5D%5BGroup%5D=&ColorList%5B19%5D%5BSelected%5D=false&ColorList%5B19%5D%5BText%5D=Beige&ColorList%5B19%5D%5BValue%5D=19&ColorList%5B20%5D%5BDisabled%5D=false&ColorList%5B20%5D%5BGroup%5D=&ColorList%5B20%5D%5BSelected%5D=false&ColorList%5B20%5D%5BText%5D=Orange&ColorList%5B20%5D%5BValue%5D=20&ColorList%5B21%5D%5BDisabled%5D=false&ColorList%5B21%5D%5BGroup%5D=&ColorList%5B21%5D%5BSelected%5D=false&ColorList%5B21%5D%5BText%5D=Burgundy&ColorList%5B21%5D%5BValue%5D=21&ColorList%5B22%5D%5BDisabled%5D=false&ColorList%5B22%5D%5BGroup%5D=&ColorList%5B22%5D%5BSelected%5D=false&ColorList%5B22%5D%5BText%5D=Metallic&ColorList%5B22%5D%5BValue%5D=22&ColorList%5B23%5D%5BDisabled%5D=false&ColorList%5B23%5D%5BGroup%5D=&ColorList%5B23%5D%5BSelected%5D=false&ColorList%5B23%5D%5BText%5D=Bronze&ColorList%5B23%5D%5BValue%5D=23&ColorList%5B24%5D%5BDisabled%5D=false&ColorList%5B24%5D%5BGroup%5D=&ColorList%5B24%5D%5BSelected%5D=false&ColorList%5B24%5D%5BText%5D=Turquoise&ColorList%5B24%5D%5BValue%5D=24&ColorList%5B25%5D%5BDisabled%5D=false&ColorList%5B25%5D%5BGroup%5D=&ColorList%5B25%5D%5BSelected%5D=false&ColorList%5B25%5D%5BText%5D=Cream&ColorList%5B25%5D%5BValue%5D=25&ColorList%5B26%5D%5BDisabled%5D=false&ColorList%5B26%5D%5BGroup%5D=&ColorList%5B26%5D%5BSelected%5D=false&ColorList%5B26%5D%5BText%5D=Jet+Black&ColorList%5B26%5D%5BValue%5D=27&ColorList%5B27%5D%5BDisabled%5D=false&ColorList%5B27%5D%5BGroup%5D=&ColorList%5B27%5D%5BSelected%5D=false&ColorList%5B27%5D%5BText%5D=Rose&ColorList%5B27%5D%5BValue%5D=28&ColorList%5B28%5D%5BDisabled%5D=false&ColorList%5B28%5D%5BGroup%5D=&ColorList%5B28%5D%5BSelected%5D=false&ColorList%5B28%5D%5BText%5D=Space+Grey&ColorList%5B28%5D%5BValue%5D=29&ItemList=&AvailableLocations%5B0%5D%5BOperationUid%5D=30&AvailableLocations%5B0%5D%5BLocationName%5D=Avanti+West+Coast&AvailableLocations%5B0%5D%5BOperationLogoPath%5D=&AvailableLocations%5B0%5D%5BOperatedBy%5D=&AvailableLocations%5B0%5D%5BAssociateName%5D=&AvailableLocations%5B0%5D%5BAssociateId%5D=0&AvailableLocations%5B0%5D%5BClaimId%5D=0&AvailableLocations%5B0%5D%5BDateSent%5D=&AvailableLocations%5B0%5D%5BDateModified%5D=&AvailableLocations%5B1%5D%5BOperationUid%5D=12&AvailableLocations%5B1%5D%5BLocationName%5D=Great+Western+Railway&AvailableLocations%5B1%5D%5BOperationLogoPath%5D=&AvailableLocations%5B1%5D%5BOperatedBy%5D=&AvailableLocations%5B1%5D%5BAssociateName%5D=&AvailableLocations%5B1%5D%5BAssociateId%5D=0&AvailableLocations%5B1%5D%5BClaimId%5D=0&AvailableLocations%5B1%5D%5BDateSent%5D=&AvailableLocations%5B1%5D%5BDateModified%5D=&AvailableLocations%5B2%5D%5BOperationUid%5D=28&AvailableLocations%5B2%5D%5BLocationName%5D=LNER+(London+North+Eastern+Railway)&AvailableLocations%5B2%5D%5BOperationLogoPath%5D=&AvailableLocations%5B2%5D%5BOperatedBy%5D=&AvailableLocations%5B2%5D%5BAssociateName%5D=&AvailableLocations%5B2%5D%5BAssociateId%5D=0&AvailableLocations%5B2%5D%5BClaimId%5D=0&AvailableLocations%5B2%5D%5BDateSent%5D=&AvailableLocations%5B2%5D%5BDateModified%5D=&AvailableLocations%5B3%5D%5BOperationUid%5D=25&AvailableLocations%5B3%5D%5BLocationName%5D=London+Northwestern+Railway&AvailableLocations%5B3%5D%5BOperationLogoPath%5D=&AvailableLocations%5B3%5D%5BOperatedBy%5D=&AvailableLocations%5B3%5D%5BAssociateName%5D=&AvailableLocations%5B3%5D%5BAssociateId%5D=0&AvailableLocations%5B3%5D%5BClaimId%5D=0&AvailableLocations%5B3%5D%5BDateSent%5D=&AvailableLocations%5B3%5D%5BDateModified%5D=&AvailableLocations%5B4%5D%5BOperationUid%5D=13&AvailableLocations%5B4%5D%5BLocationName%5D=ScotRail&AvailableLocations%5B4%5D%5BOperationLogoPath%5D=&AvailableLocations%5B4%5D%5BOperatedBy%5D=&AvailableLocations%5B4%5D%5BAssociateName%5D=&AvailableLocations%5B4%5D%5BAssociateId%5D=0&AvailableLocations%5B4%5D%5BClaimId%5D=0&AvailableLocations%5B4%5D%5BDateSent%5D=&AvailableLocations%5B4%5D%5BDateModified%5D=&AvailableLocations%5B5%5D%5BOperationUid%5D=17&AvailableLocations%5B5%5D%5BLocationName%5D=South+Western+Railway&AvailableLocations%5B5%5D%5BOperationLogoPath%5D=&AvailableLocations%5B5%5D%5BOperatedBy%5D=&AvailableLocations%5B5%5D%5BAssociateName%5D=&AvailableLocations%5B5%5D%5BAssociateId%5D=0&AvailableLocations%5B5%5D%5BClaimId%5D=0&AvailableLocations%5B5%5D%5BDateSent%5D=&AvailableLocations%5B5%5D%5BDateModified%5D=&AvailableLocations%5B6%5D%5BOperationUid%5D=15&AvailableLocations%5B6%5D%5BLocationName%5D=TransPennine+Express&AvailableLocations%5B6%5D%5BOperationLogoPath%5D=&AvailableLocations%5B6%5D%5BOperatedBy%5D=&AvailableLocations%5B6%5D%5BAssociateName%5D=&AvailableLocations%5B6%5D%5BAssociateId%5D=0&AvailableLocations%5B6%5D%5BClaimId%5D=0&AvailableLocations%5B6%5D%5BDateSent%5D=&AvailableLocations%5B6%5D%5BDateModified%5D=&AvailableLocations%5B7%5D%5BOperationUid%5D=33&AvailableLocations%5B7%5D%5BLocationName%5D=Transport+for+Wales&AvailableLocations%5B7%5D%5BOperationLogoPath%5D=&AvailableLocations%5B7%5D%5BOperatedBy%5D=&AvailableLocations%5B7%5D%5BAssociateName%5D=&AvailableLocations%5B7%5D%5BAssociateId%5D=0&AvailableLocations%5B7%5D%5BClaimId%5D=0&AvailableLocations%5B7%5D%5BDateSent%5D=&AvailableLocations%5B7%5D%5BDateModified%5D=&AvailableLocations%5B8%5D%5BOperationUid%5D=26&AvailableLocations%5B8%5D%5BLocationName%5D=West+Midlands+Trains&AvailableLocations%5B8%5D%5BOperationLogoPath%5D=&AvailableLocations%5B8%5D%5BOperatedBy%5D=&AvailableLocations%5B8%5D%5BAssociateName%5D=&AvailableLocations%5B8%5D%5BAssociateId%5D=0&AvailableLocations%5B8%5D%5BClaimId%5D=0&AvailableLocations%5B8%5D%5BDateSent%5D=&AvailableLocations%5B8%5D%5BDateModified%5D=&IsReloadResults=true'
            )

        r = requests.post(
            'https://www.missingx.com/en/search/loadsearchlistresults',
            headers=self.headers,
            data=f'SearchToken={self.search_token}'
            )

        soup = BeautifulSoup(r.text, "html.parser")
        cards = soup.find_all("div", class_="item-list-card")
        for card in cards:
            try:
                results.append({
                    "id": card.find(attrs={"title": "Click here to claim this item"}).get("id").replace("btn_claim_", ""),
                    "title": card.find("h1").text.strip(),
                    "found_date": card.find(class_="card-found-date").find(class_="card-details-value").text,
                    "location": card.find(class_="card-found-details").find(class_="card-details-value").text,
                    "location_category": card.find(class_="card-found-details").find(class_="card-details-label").text.replace(": ", ""),
                    "registered_by": card.find(class_="card-associate").find(class_="card-details-value").text,
                })
            except:
                pass
        
        return results